<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>PiCam</title>
    <style type="text/css">
        .style1 {
            width: 50%;
        }

        .space {
            margin-top: 500px;
        }
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script language="javascript" type="text/javascript">

        function beep() {
            (new
                    Audio(
                    "data:audio/wav;base64,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 /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU="
            )).play();
        }

        // Activate image clicking forwarding.
        $('#image_placeholder').ready(function () {
            $('img').click(function (e) {
                var offset = $(this).offset();
                var x_offset = e.pageX - offset.left;
                var y_offset = e.pageY - offset.top;

                $.ajax({
                    url: "cmd/clicked_picture",
                    type: 'GET',
                    data: {
                        x: x_offset,
                        y: y_offset,
                        width: $(this).width(),
                        height: $(this).height()
                    },
                    success: function (data) {
                        alert(data);
                    }
                });
            });
        });

        function getClickPosition(e) {
            console.log(e.clientX + " " + e.clientY);
        }

        var isStreaming = false;
        var responseTime = new Date().getTime(); // Used for request->response timing
        //        $('#image_placeholder').on("click", function() { alert('fuck')}, false)

        function Button_onclick(direction) {
            $.ajax({url: '/' + direction});
        }


        // Sends custom command to the server.
        function send_debug_command(command) {
            $.ajax({
                url: command,
                type: 'GET',
                success: function (data) {
                    $('#debug_log').text(data)
                }
            })
        }

        // Request a single image from the server.
        function request_image(callback) {
            $('#timestamp').text("Requesting image..."); // Mark timestamp
            responseTime = new Date().getTime();

            $.ajax({
                url: '/cmd/req_picture',
                type: 'GET',
                success: callback
            })
        }

        function handle_image_response(data) {
            var json_data = JSON.parse(data);

            var img = json_data['encoded_picture'];
            var timestamp = json_data['timestamp'];
            var cv_operation = json_data['cv_operation'];

            var nowTime = new Date().getTime();

            // Write image data to placeholder
            $('#image_placeholder').attr("src", "data:image/jpg;base64," + img);
            $('#timestamp').text("Picture taken on: " + timestamp); // Mark timestamp
            $('#ping').text("Response time: " + ((nowTime - responseTime) / 1000) + " seconds.");

            handle_operation_selection(cv_operation);
        }

        function handle_operation_selection(cv_operation) {
            $('#notify_on_motion')[0].disabled = true;

            if (cv_operation == {{RAW_IMAGE}})
                $('#operation_raw')[0].selected = true
            else if (cv_operation == {{FACE_DETECTION}})
                $('#operation_face')[0].selected = true
            else if (cv_operation == {{MOTION_DETECTION}})
            {
                $('#operation_motion')[0].selected = true;
                $('#notify_on_motion')[0].disabled = false;
            }
            else if (cv_operation == {{CANNY_EDGE_DETECTION}})
                $('#operation_canny_edge')[0].selected = true
            else if (cv_operation == {{CORNER_DETECTION}})
                $('#operation_corner')[0].selected = true
            else if (cv_operation == {{KEYPOINT_DETECTION}})
                $('#operation_keypoint')[0].selected = true
        }

        var imgCount = 0;
        // FPS Counter
        window.setInterval(function () { // Every 200 ms
            if (isStreaming) {
                $('#ping').text(imgCount + " frames per second."); // Crude FPS counter
                imgCount = 0;
            }
        }, 1000)

        // Start automatic streaming (As of right now, it's a pseudostream ;))
        function start_stream_request() {
            if (!isStreaming) return;
            $('#timestamp').text("Live stream started"); // Mark timestamp
            responseTime = new Date().getTime();

            $.ajax({
                url: '/cmd/req_picture',
                type: 'GET',
                success: handle_image_stream
            })
        }

        var imgCount = 0;
        var beepOnMotionDetect = false;
        var beeped_since_last_motion = false;
        function handle_image_stream(data) {
            var json_data = JSON.parse(data);
            imgCount++;

            var img = json_data['encoded_picture'];
            var timestamp = json_data['timestamp'];
            var cv_operation = json_data['cv_operation'];
            var motion_detected = json_data['motion_detected']; // Is undefined if it hasn't been enabled
            var get_notify_on_motion = json_data['notify_motion'] == "true";

            var nowTime = new Date().getTime();

            ////////////////////////////
            // Motion Detection Alert //
            ////////////////////////////
            if (get_notify_on_motion == true && beepOnMotionDetect == true) {
                if (motion_detected) {
                    if (!beeped_since_last_motion) {
                        beep();
                        beeped_since_last_motion = true;
                    }
                } else if (!motion_detected) {
                    beeped_since_last_motion = false;
                }
            }
            $('#notify_on_motion')[0].checked = (get_notify_on_motion);
            beepOnMotionDetect = (get_notify_on_motion);
            ////////////////////////

            // Write image data to placeholder
            $('#image_placeholder').attr("src", "data:image/jpg;base64," + img);
            $('#timestamp').text("Picture taken on: " + timestamp); // Mark timestamp
            handle_operation_selection(cv_operation);

            start_stream_request();
        }

        // Request a single image from the server.
        function request_operation_change(operation) {
            $.ajax({
                url: '/cmd/' + operation,
                type: 'GET'
            })
        }

        function request_notify_state_change(state) {
            $.ajax({
                url: '/cmd/set_notify_motion',
                type: 'GET',
                data: {
                    bool: state
                },
                success: function (data) {
                    beepOnMotionDetect = (data == "true");
                }
            })
        }

    </script>
</head>
<body onload="request_image(handle_image_response)">

<table align="center" class="style1">
    <tr>
        <td colspan="2" style="text-align: center">
            <div id="timestamp">Picture taken on: 2017-01-07 at 12.18.52 PM</div>
            <img id="image_placeholder" src="data:image/jpeg;base64,"/>
            <!--<img src="{{url_for('video_feed')}}" />-->
            <div id="ping">Response Time: 0.022 seconds.</div>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="text-align: center">
            <input id="btnPic" type="button" value="Take Picture" onclick="request_image(handle_image_response)"/>
            <input id="btnStream" type="button" value="Start Live Stream"
                   onclick="new function()
                                {
                                    if (isStreaming) {
                                        // Turn off live streaming
                                        $('#btnStream').attr('value', 'Start Live Stream')
                                        $('#btnPic').prop('disabled', false);
                                    } else {
                                        // Turn on live streaming
                                        $('#btnStream').attr('value', 'End Live Stream');
                                        $('#btnPic').prop('disabled', true);
                                    }
                                    isStreaming = !isStreaming;
                                    start_stream_request();
            }"/>
            <br><br>
            <select id="operation" size="6" style="width: 125px; text-align: center;">
                <option id="operation_raw" onclick="request_operation_change(this.value)" value="cv_raw_img">Raw Image
                </option>
                <option id="operation_face" onclick="request_operation_change(this.value)" value="cv_face_detect">Face
                    Detection
                </option>
                <option id="operation_motion" onclick="request_operation_change(this.value)" value="cv_motion_detect">
                    Motion Detection
                </option>
                <option id="operation_canny_edge" onclick="request_operation_change(this.value)"
                        value="cv_canny_edge_detect">Canny Edge Detection
                </option>
                <option id="operation_corner" onclick="request_operation_change(this.value)" value="cv_corner_detect">
                    Corner Detection
                </option>
                <option id="operation_keypoint" onclick="request_operation_change(this.value)"
                        value="cv_keypoint_detect">Keypoint Detection
                </option>
            </select>
            <br><input type="checkbox" id="notify_on_motion" onchange="request_notify_state_change(this.checked)">Notify on Motion Detection<br>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="text-align: center">
            <p></p><br>
            Debugger:
            <br>
            <textarea id="debug_cmd" rows="4" cols="50" value="Input commands here">/cmd/req_picture</textarea>
            <br>
            <input id="debug_send" type="button" value="Send Command"
                   onclick="send_debug_command($('#debug_cmd')[0].value)"/>
            <br><br>
            <textarea id="debug_log" rows="48" cols="160" readonly>Output</textarea><br>
            <!--<input id="btnUp" type="button" value="Start Live Stream" onclick="start_stream()"/>-->
            <div class="space"></div>
        </td>
    </tr>
</table>
</body>
</html>
